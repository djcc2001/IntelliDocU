Fase 8: RAG Avanzado con Abstención y Citación Basada en Fragmentos
-----------------------------------------------------------------

Esta fase tuvo como objetivo implementar y validar la versión v3_rag_advanced del sistema IntelliDocU, incorporando mecanismos de control sobre la generación de respuestas mediante abstención explícita y citación basada en los fragmentos recuperados. El enfoque de esta versión prioriza la confiabilidad de las respuestas, evitando la generación de contenido no respaldado por evidencia textual.

==================================================
1. Objetivo de la fase
==================================================

El objetivo principal de la Fase 8 fue:

    - Extender el pipeline RAG básico hacia una versión avanzada (v3_rag_advanced).
    - Restringir al modelo a responder únicamente con información presente en los fragmentos recuperados.
    - Incorporar citación explícita a nivel de documento, página y fragmento.
    - Implementar una política de abstención cuando no existe evidencia suficiente.
    - Reducir la generación de respuestas no fundamentadas.

Esta fase prioriza la precisión y la trazabilidad documental sobre la cobertura de respuestas.

==================================================
2. Estructura de archivos utilizada
==================================================

La estructura utilizada en esta fase es la siguiente:

    IntelliDocU/
      src/
        common/
          retriever/
            retriever.py
            load_index.py
          llm/
            flan_t5_llm.py
        v3_rag_advanced/
          abstention.py
          context_builder.py
          run_rag.py
          run_rag_eval.py

Los componentes comunes (recuperación y modelo de lenguaje) son reutilizados, mientras que la lógica avanzada del pipeline RAG se encapsula en el módulo v3_rag_advanced.

==================================================
3. Construcción del pipeline RAG avanzado (v3)
==================================================

El pipeline principal se implementa en el archivo:

    src/v3_rag_advanced/run_rag.py

El flujo completo del sistema es el siguiente:

    1. Recepción de la pregunta del usuario.
    2. Recuperación de fragmentos relevantes mediante FAISS.
    3. Selección de fragmentos con mayor relevancia semántica.
    4. Evaluación de la política de abstención.
    5. Construcción de un prompt restrictivo que:
        - Limita la respuesta exclusivamente al contenido de los fragmentos.
        - Prohíbe la invención de información no presente en el contexto.
        - Solicita una respuesta breve y comprensible.
    6. Generación de la respuesta mediante el modelo Flan-T5.
    7. Agregado de citas globales correspondientes a los fragmentos utilizados.

==================================================
4. Política de abstención implementada
==================================================

La política de abstención se define en el archivo:

    src/v3_rag_advanced/abstention.py

El sistema se abstiene de responder y devuelve el mensaje:

    "It is not mentioned in the document."

cuando se cumple alguna de las siguientes condiciones:

    - No se recuperan fragmentos relevantes.
    - Todos los fragmentos tienen un score inferior al umbral mínimo.
    - La pregunta está fuera del dominio de los documentos indexados.
    - La pregunta es demasiado corta o ambigua.
    - Existe un número insuficiente de fragmentos relevantes.

Este mecanismo evita inferencias no verificables y reduce significativamente el riesgo de alucinaciones.

==================================================
5. Citación basada en fragmentos
==================================================

Las respuestas generadas incluyen citación explícita basada en los fragmentos utilizados para construir el contexto.

El formato de citación utilizado es:

    [cita: doc=DOC_ID, p=PAGE, frag=FRAG_ID]

Las citas se agregan de forma global al final de la respuesta y corresponden a todos los fragmentos empleados durante la generación. El sistema no implementa validación automática de citas ni citación por afirmación individual.

==================================================
6. Ejecución del sistema
==================================================

Para ejecutar una prueba individual del sistema:

    python -m src.v3_rag_advanced.run_rag

Durante la validación se utilizó la pregunta:

    "What is SparseSwaps?"

En este caso, el sistema activó correctamente la política de abstención al no encontrar evidencia textual suficiente en los fragmentos recuperados.

==================================================
7. Evaluación sobre el conjunto de preguntas
==================================================

La evaluación automática se realiza mediante el script:

    python -m src.v3_rag_advanced.run_rag_eval

Este script:

    - Carga un conjunto de preguntas desde un archivo JSON.
    - Ejecuta el pipeline RAG avanzado para cada pregunta.
    - Aplica la política de abstención cuando corresponde.
    - Almacena todas las respuestas generadas en formato JSON.

Los resultados se almacenan en:

    results/v3_rag_advanced/rag_advanced_answers.json

==================================================
8. Resultados de la fase
==================================================

Al finalizar esta fase se confirmó que:

    - El pipeline RAG avanzado funciona correctamente.
    - El sistema responde únicamente cuando existe evidencia suficiente.
    - La abstención se activa de manera consistente.
    - Las respuestas son más conservadoras pero más confiables.
    - Se reduce el riesgo de generación de contenido no fundamentado.

==================================================
9. Conclusión
==================================================

La Fase 8 consolida un enfoque de RAG orientado a confiabilidad y trazabilidad documental dentro del sistema IntelliDocU. Mediante la combinación de abstención explícita y citación basada en fragmentos, el sistema prioriza la precisión sobre la cobertura, estableciendo una base sólida para futuras extensiones orientadas a validación automática de citas y control más fino de la generación de respuestas.
